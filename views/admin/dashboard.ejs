<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - HIFI Database</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/admin-dashboard.css">
</head>
<body>
    <!-- Background Shapes -->
    <div class="bg-shape bg-shape-1"></div>
    <div class="bg-shape bg-shape-2"></div>
    <div class="bg-shape bg-shape-3"></div>

    <!-- Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Top Navigation -->
        <%- include('partials/navbar') %>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Page Header -->
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="dashboard-title mb-2">Database Management</h2>
                        <p class="dashboard-subtitle mb-0">Kelola data warga HIFI dengan mudah</p>
                    </div>
                    <button class="btn-refresh" onclick="refreshData()" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Alert Messages (FIXED) -->
            <% if (typeof message !== 'undefined' && message !== '') { %>
                <div id="alert-border-3" class="alert alert-<%= status === 'success' ? 'success' : status === 'danger' ? 'danger' : 'info' %> alert-dismissible fade show" role="alert" style="margin-bottom: 24px;">
                    <i class="fas fa-<%= status === 'success' ? 'check-circle' : status === 'danger' ? 'exclamation-circle' : 'info-circle' %> me-2"></i>
                    <span><%= message %></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card" data-animate>
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #DC143C 0%, #FF1744 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-body">
                        <p class="stat-card-title">Total Users</p>
                        <h3 class="stat-card-value" data-counter="<%= totalUsers %>"><%= totalUsers %></h3>
                        <span class="stat-card-trend">
                            <i class="fas fa-arrow-up"></i> 100%
                        </span>
                    </div>
                </div>

                <div class="stat-card" data-animate>
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-card-body">
                        <p class="stat-card-title">Admin Users</p>
                        <h3 class="stat-card-value" data-counter="<%= adminUsers %>"><%= adminUsers %></h3>
                        <span class="stat-card-trend">
                            <i class="fas fa-arrow-up"></i> <%= ((adminUsers / totalUsers) * 100).toFixed(1) %>%
                        </span>
                    </div>
                </div>

                <div class="stat-card" data-animate>
                    <div class="stat-card-icon" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-card-body">
                        <p class="stat-card-title">Regular Users</p>
                        <h3 class="stat-card-value" data-counter="<%= regularUsers %>"><%= regularUsers %></h3>
                        <span class="stat-card-trend">
                            <i class="fas fa-arrow-up"></i> <%= ((regularUsers / totalUsers) * 100).toFixed(1) %>%
                        </span>
                    </div>
                </div>
            </div>

            <!-- User Table Card -->
            <div class="glass-card table-container">
                <div class="table-header">
                    <h5 class="table-title">
                        <i class="fas fa-database me-2"></i>
                        Data Warga HIFI
                    </h5>
                </div>
                
                <div class="table-responsive">
                    <table id="usersTable" class="table table-glass" style="width:100%">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Username</th>
                                <th>NPM</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th class="no-export">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach((user, index) => { %>
                            <tr class="user-row" data-user-id="<%= user._id %>" data-username="<%= user.username %>" data-npm="<%= user.npm %>" data-email="<%= user.email %>" data-role="<%= user.isAdmin ? 'Admin' : 'User' %>">
                                <td><%= index + 1 %></td>
                                <td class="fw-bold text-dark"><%= user.username %></td>
                                <td><%= user.npm %></td>
                                <td><%= user.email %></td>
                                <td>
                                    <% if (user.isAdmin) { %>
                                        <span class="badge-glass badge-red">
                                            <i class="fas fa-shield-alt me-1"></i>Admin
                                        </span>
                                    <% } else { %>
                                        <span class="badge-glass badge-blue">
                                            <i class="fas fa-user me-1"></i>User
                                        </span>
                                    <% } %>
                                </td>
                                <td class="no-export">
                                    <button class="btn-action btn-view" onclick="viewUserInfo('<%= user._id %>')" title="View Info">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/admin/edit/<%= user._id %>" class="btn-action btn-edit" title="Edit User">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn-action btn-delete" onclick="deleteUser('<%= user._id %>', '<%= user.username %>')" title="Delete User">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <%- include('partials/footer') %>
    </div>

    <!-- User Info Modal -->
    <div class="modal fade" id="userInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-glass">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-gradient">
                        <i class="fas fa-user-circle me-2"></i>
                        User Information
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="user-info-card">
                        <div class="user-avatar-large mb-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info-details">
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-user me-2"></i>Username:
                                </span>
                                <span class="info-value" id="modal-username">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-id-card me-2"></i>NPM:
                                </span>
                                <span class="info-value" id="modal-npm">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-envelope me-2"></i>Email:
                                </span>
                                <span class="info-value" id="modal-email">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-shield-alt me-2"></i>Role:
                                </span>
                                <span class="info-value" id="modal-role">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="modal-edit-btn" class="btn btn-primary-gradient">
                        <i class="fas fa-edit me-2"></i>Edit User
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="/javascript/admin-animations.js"></script>
    
    <script>
        // Initialize DataTable
        $(document).ready(function() {
            const table = $('#usersTable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                language: {
                    search: "🔍",
                    searchPlaceholder: "Cari nama, NPM, email...",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ users",
                    infoEmpty: "No users available",
                    infoFiltered: "(filtered from _MAX_ total)",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Prev"
                    },
                    emptyTable: "No data available",
                    zeroRecords: "No matching records found"
                },
                dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>B<"row"<"col-sm-12"rt>><"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel me-2"></i>Export Excel',
                        className: 'dt-button',
                        title: 'HIFI Database Export',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf me-2"></i>Export PDF',
                        className: 'dt-button',
                        title: 'HIFI Database Export',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print me-2"></i>Print',
                        className: 'dt-button',
                        title: 'HIFI Database',
                        exportOptions: {
                            columns: ':not(.no-export)'
                        }
                    }
                ],
                order: [[0, 'asc']],
                columnDefs: [
                    { orderable: false, targets: -1 },
                    { className: 'text-center', targets: 0 }
                ],
                initComplete: function() {
                    $('#usersTable').css('opacity', '0').animate({ opacity: 1 }, 600);
                    $('.dataTables_filter input').attr('placeholder', 'Search...');
                },
                drawCallback: function() {
                    $('#usersTable tbody tr').hover(
                        function() {
                            $(this).addClass('table-row-hover');
                        },
                        function() {
                            $(this).removeClass('table-row-hover');
                        }
                    );
                }
            });
        });

        // Delete User Function
        function deleteUser(userId, username) {
            if (confirm(`Apakah Anda yakin ingin menghapus user "${username}"?`)) {
                fetch(`/admin/delete/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('User berhasil dihapus!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Gagal menghapus user!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Terjadi kesalahan!', 'error');
                });
            }
        }

        // View User Info Function
        function viewUserInfo(userId) {
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (row) {
                const username = row.dataset.username;
                const npm = row.dataset.npm;
                const email = row.dataset.email;
                const role = row.dataset.role;

                document.getElementById('modal-username').textContent = username;
                document.getElementById('modal-npm').textContent = npm;
                document.getElementById('modal-email').textContent = email;
                document.getElementById('modal-role').textContent = role;
                document.getElementById('modal-edit-btn').href = `/admin/edit/${userId}`;

                const modal = new bootstrap.Modal(document.getElementById('userInfoModal'));
                modal.show();
            }
        }

        // Refresh Data Function
        function refreshData() {
            const refreshBtn = document.querySelector('.btn-refresh');
            const icon = refreshBtn.querySelector('i');
            
            icon.style.animation = 'spin 0.6s linear';
            
            setTimeout(() => {
                location.reload();
            }, 600);
        }

        // Simple Toast Function (if not in admin-animations.js)
        function showToast(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.style.cssText = 'position: fixed; top: 24px; right: 24px; z-index: 10000; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
