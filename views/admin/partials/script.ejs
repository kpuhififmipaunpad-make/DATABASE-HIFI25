<!-- Font Awesome Icon -->
<script src="https://kit.fontawesome.com/7cc967098c.js" crossorigin="anonymous"></script>
<!-- Iconify -->
<script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@2.2.1/dist/iconify.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables Core -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- DataTable Initialization Script -->
<script>
$(document).ready(function() {
  console.log('üöÄ Initializing DataTable...');
  
  // Destroy existing instance if any
  if ($.fn.DataTable.isDataTable('#usersTable')) {
    $('#usersTable').DataTable().destroy();
    console.log('‚ôªÔ∏è Destroyed existing DataTable instance');
  }

  // Initialize DataTable
  const table = $('#usersTable').DataTable({
    // Core Settings
    responsive: false,
    autoWidth: false,
    processing: true,
    deferRender: true,
    
    // Display Settings
    pageLength: 10,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]],
    
    // Feature Controls
    lengthChange: true,
    searching: true,
    ordering: true,
    info: true,
    paging: true,
    
    // Scroll Settings
    scrollX: true,
    scrollCollapse: true,
    
    // Layout
    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
         'B' +
         '<"row"<"col-sm-12"tr>>' +
         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
    
    // Language Settings
    language: {
      search: "Cari:",
      searchPlaceholder: "Ketik untuk mencari...",
      lengthMenu: "Tampilkan _MENU_ data",
      info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
      infoEmpty: "Tidak ada data",
      infoFiltered: "(disaring dari _MAX_ total)",
      zeroRecords: "Data tidak ditemukan",
      emptyTable: "Tidak ada data tersedia",
      loadingRecords: "Memuat data...",
      processing: "Memproses...",
      paginate: {
        first: "Pertama",
        last: "Terakhir",
        next: "Berikutnya",
        previous: "Sebelumnya"
      }
    },
    
    // Column Settings
    columnDefs: [
      { 
        targets: 0, 
        width: '50px',
        orderable: true 
      },
      { 
        targets: -1, 
        orderable: false,
        className: 'no-export'
      }
    ],
    
    // Order Settings
    order: [[2, 'asc']],
    
    // Buttons Configuration
    buttons: [
      {
        extend: 'excel',
        text: '<i class="fas fa-file-excel"></i> Export Excel',
        className: 'dt-button buttons-excel',
        title: 'Data Warga HIFI - ' + new Date().toLocaleDateString('id-ID'),
        exportOptions: {
          columns: ':not(.no-export)'
        },
        filename: 'data-hifi-' + new Date().toISOString().split('T')[0]
      },
      {
        extend: 'pdf',
        text: '<i class="fas fa-file-pdf"></i> Export PDF',
        className: 'dt-button buttons-pdf',
        title: 'Data Warga HIFI',
        orientation: 'landscape',
        pageSize: 'A4',
        exportOptions: {
          columns: ':not(.no-export)'
        },
        filename: 'data-hifi-' + new Date().toISOString().split('T')[0],
        customize: function(doc) {
          doc.defaultStyle.fontSize = 9;
          doc.styles.tableHeader = {
            fontSize: 10,
            bold: true,
            fillColor: '#1E3A8A',
            color: 'white',
            alignment: 'left'
          };
          doc.content[1].table.widths = Array(doc.content[1].table.body[0].length).fill('*');
        }
      },
      {
        extend: 'print',
        text: '<i class="fas fa-print"></i> Print',
        className: 'dt-button buttons-print',
        title: 'Data Warga HIFI',
        messageTop: '<h3 style="text-align:center; color:#DC143C; margin-bottom:20px;">Data Warga HIFI</h3><p style="text-align:center; margin-bottom:20px;">Dicetak pada: ' + new Date().toLocaleString('id-ID') + '</p>',
        exportOptions: {
          columns: ':not(.no-export)'
        },
        customize: function(win) {
          $(win.document.body)
            .css('font-size', '10pt')
            .prepend('<style>@media print { body { padding: 20px; } table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid #ddd; padding: 8px; } thead { background-color: #1E3A8A !important; color: white !important; -webkit-print-color-adjust: exact; } }</style>');
          
          $(win.document.body).find('table')
            .addClass('compact')
            .css('font-size', '9pt');
        }
      }
    ],
    
    // Callbacks
    initComplete: function() {
      console.log('‚úÖ DataTable initialized successfully');
      
      // Add custom styling
      $('.dataTables_wrapper').addClass('glass-card');
      
      // Style inputs
      $('.dataTables_filter input')
        .attr('placeholder', 'Cari data...')
        .css({
          'border': '2px solid rgba(30, 58, 138, 0.2)',
          'border-radius': '12px',
          'padding': '10px 16px'
        });
      
      // Style select
      $('.dataTables_length select').css({
        'border': '2px solid rgba(30, 58, 138, 0.2)',
        'border-radius': '10px',
        'padding': '8px 32px 8px 12px'
      });
      
      // Animate initial rows
      $('#usersTable tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.4s ease-out',
          'animation-delay': (index * 0.05) + 's',
          'animation-fill-mode': 'both'
        });
      });
    },
    
    drawCallback: function() {
      // Animate rows on redraw
      $('#usersTable tbody tr').each(function(index) {
        $(this).css({
          'animation': 'fadeInUp 0.3s ease-out',
          'animation-delay': (index * 0.03) + 's',
          'animation-fill-mode': 'both'
        });
      });
      
      console.log('üîÑ Table redrawn');
    }
  });

  // Row click event for detail expansion
  $('#usersTable tbody').on('click', 'tr', function(e) {
    // Prevent expansion when clicking action buttons
    if ($(e.target).closest('.btn-action, .no-export').length > 0) {
      return;
    }

    const row = table.row(this);
    
    if (row.child.isShown()) {
      // Close detail
      row.child.hide();
      $(this).removeClass('shown');
      console.log('‚ùå Detail row closed');
    } else {
      // Close all other details first
      table.rows().every(function() {
        if (this.child.isShown()) {
          this.child.hide();
          $(this.node()).removeClass('shown');
        }
      });
      
      // Open this detail
      const data = row.data();
      row.child(formatDetailRow(data)).show();
      $(this).addClass('shown');
      
      console.log('‚úÖ Detail row opened');
      
      // Animate detail card
      setTimeout(() => {
        $(row.child()).find('.detail-card').css({
          'animation': 'fadeInUp 0.4s ease-out',
          'animation-fill-mode': 'both'
        });
      }, 10);
    }
  });

  // Format detail row
  function formatDetailRow(data) {
    // Extract data safely
    const username = $(data[1]).text().trim() || data[1].replace(/<[^>]*>/g, '').trim();
    const nama = data[2] || '-';
    const npm = data[3] || '-';
    const email = data[4] || '-';
    const noHp = data[5] || '-';
    const role = data[6] ? (data[6].includes('Admin') ? 'Administrator' : 'User') : 'User';
    const lastUpdate = data[7] || '-';
    
    return `
      <div class="detail-card" style="background: rgba(255,255,255,0.98); border-radius: 16px; padding: 24px; margin: 10px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);">
        <div class="row">
          <div class="col-md-6" style="margin-bottom: 20px;">
            <h6 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-user-circle"></i> Informasi Personal
            </h6>
            <p style="margin-bottom: 12px; font-size: 14px; color: #374151;"><strong>Username:</strong> ${username}</p>
            <p style="margin-bottom: 12px; font-size: 14px; color: #374151;"><strong>Nama Lengkap:</strong> ${nama}</p>
            <p style="margin-bottom: 12px; font-size: 14px; color: #374151;"><strong>NPM:</strong> ${npm}</p>
            <p style="margin-bottom: 0; font-size: 14px; color: #374151;"><strong>Role:</strong> ${role}</p>
          </div>
          <div class="col-md-6" style="margin-bottom: 20px;">
            <h6 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-address-card"></i> Kontak & Informasi
            </h6>
            <p style="margin-bottom: 12px; font-size: 14px; color: #374151;"><strong>Email:</strong> ${email}</p>
            <p style="margin-bottom: 12px; font-size: 14px; color: #374151;"><strong>No. HP:</strong> ${noHp}</p>
            <p style="margin-bottom: 0; font-size: 14px; color: #374151;"><strong>Terakhir Update:</strong> ${lastUpdate}</p>
          </div>
        </div>
      </div>
    `;
  }

  console.log('üéâ DataTable setup complete!');
});

// Delete confirmation function
function confirmDelete(id) {
  if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/dashboard/delete/${id}?_method=DELETE`;
    
    const csrf = document.querySelector('input[name="_csrf"]');
    if (csrf) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = '_csrf';
      csrfInput.value = csrf.value;
      form.appendChild(csrfInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Counter Animation for Stats
document.querySelectorAll('[data-counter]').forEach(counter => {
  const target = parseInt(counter.getAttribute('data-counter'));
  const duration = 2000;
  const step = target / (duration / 16);
  let current = 0;
  
  const timer = setInterval(() => {
    current += step;
    if (current >= target) {
      counter.textContent = target;
      clearInterval(timer);
    } else {
      counter.textContent = Math.floor(current);
    }
  }, 16);
});
</script>

<!-- Admin Animations -->
<script src="/javascript/admin-animations.js"></script>

</body>
</html>
