<!-- Font Awesome Icon -->
<script src="https://kit.fontawesome.com/7cc967098c.js" crossorigin="anonymous"></script>
<!-- Iconify -->
<script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@2.2.1/dist/iconify.min.js"></script>
<!-- jQuery -->
<script src="/adminlte/plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="/adminlte/plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="/adminlte/plugins/chart.js/Chart.min.js"></script>
<!-- Sparkline -->
<script src="/adminlte/plugins/sparklines/sparkline.js"></script>
<!-- JQVMap -->
<script src="/adminlte/plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="/adminlte/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="/adminlte/plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="/adminlte/plugins/moment/moment.min.js"></script>
<script src="/adminlte/plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="/adminlte/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="/adminlte/plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="/adminlte/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="/adminlte/dist/js/adminlte.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/adminlte/dist/js/demo.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="/adminlte/dist/js/pages/dashboard.js"></script>
<!-- bs-custom-file-input -->
<script src="/adminlte/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>

<!-- DataTables & Plugins -->
<script src="/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/jszip/jszip.min.js"></script>
<script src="/adminlte/plugins/pdfmake/pdfmake.min.js"></script>
<script src="/adminlte/plugins/pdfmake/vfs_fonts.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>

<!-- ============================================
     UNIFIED DATATABLE INITIALIZATION
     ============================================ -->
<script>
  $(function () {
    // Destroy existing DataTable if exists
    if ($.fn.DataTable.isDataTable('#usersTable')) {
      $('#usersTable').DataTable().destroy();
    }

    // MASTER DataTable Configuration
    const table = $('#usersTable').DataTable({
      // Core Settings
      responsive: true,
      autoWidth: false,
      lengthChange: true,
      searching: true,
      ordering: true,
      info: true,
      paging: true,
      scrollX: true,
      scrollCollapse: true,
      
      // Pagination
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]],
      
      // Language (Indonesian)
      language: {
        search: "Cari:",
        searchPlaceholder: "Ketik untuk mencari...",
        lengthMenu: "Tampilkan _MENU_ data per halaman",
        info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
        infoEmpty: "Tidak ada data",
        infoFiltered: "(difilter dari _MAX_ total data)",
        zeroRecords: "Tidak ada data yang cocok",
        emptyTable: "Tidak ada data tersedia",
        paginate: {
          first: "Pertama",
          last: "Terakhir",
          next: "Selanjutnya",
          previous: "Sebelumnya"
        },
        loadingRecords: "Memuat...",
        processing: "Memproses..."
      },
      
      // DOM Layout
      dom: '<"datatable-wrapper"' +
           '<"datatable-top"' +
           '<"datatable-top-left"l>' +
           '<"datatable-top-center"B>' +
           '<"datatable-top-right"f>' +
           '>' +
           '<"datatable-table-wrapper"t>' +
           '<"datatable-bottom"' +
           '<"datatable-bottom-left"i>' +
           '<"datatable-bottom-right"p>' +
           '>' +
           '>',
      
      // Export Buttons
      buttons: [
        {
          extend: 'excel',
          text: '<i class="fas fa-file-excel"></i> Excel',
          className: 'btn-export btn-excel',
          title: 'Data Warga HIFI - ' + new Date().toLocaleDateString('id-ID'),
          exportOptions: {
            columns: ':not(.no-export)'
          },
          customize: function(xlsx) {
            var sheet = xlsx.xl.worksheets['sheet1.xml'];
            $('row c[r^="A"]', sheet).attr('s', '2');
          }
        },
        {
          extend: 'pdf',
          text: '<i class="fas fa-file-pdf"></i> PDF',
          className: 'btn-export btn-pdf',
          title: 'Data Warga HIFI',
          orientation: 'landscape',
          pageSize: 'A4',
          exportOptions: {
            columns: ':not(.no-export)'
          },
          customize: function(doc) {
            doc.defaultStyle.fontSize = 10;
            doc.styles.tableHeader.fontSize = 11;
            doc.styles.tableHeader.fillColor = '#1E3A8A';
            doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
          }
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print"></i> Print',
          className: 'btn-export btn-print',
          title: 'Data Warga HIFI',
          messageTop: '<h3 style="text-align:center; color:#DC143C;">Data Warga HIFI</h3><p style="text-align:center;">Dicetak pada: ' + new Date().toLocaleString('id-ID') + '</p>',
          exportOptions: {
            columns: ':not(.no-export)'
          },
          customize: function(win) {
            $(win.document.body).css('font-size', '10pt');
            $(win.document.body).find('table').addClass('compact').css('font-size', '9pt');
          }
        }
      ],
      
      // Column Definitions
      columnDefs: [
        {
          targets: 0,
          width: '50px',
          className: 'text-center'
        },
        {
          targets: -1,
          orderable: false,
          className: 'text-center no-export',
          width: '120px'
        }
      ],
      
      // Order
      order: [[1, 'asc']],
      
      // Callbacks
      initComplete: function() {
        console.log('‚úÖ DataTable initialized successfully');
        
        // Apply custom styling
        $('.dataTables_filter input')
          .addClass('dt-search-input')
          .attr('placeholder', 'Cari data...');
        
        $('.dataTables_length select')
          .addClass('dt-length-select');
      },
      
      drawCallback: function() {
        // Animate rows on draw
        $('#usersTable tbody tr').each(function(index) {
          $(this).css({
            'animation': 'fadeInRow 0.3s ease-out',
            'animation-delay': (index * 0.03) + 's',
            'animation-fill-mode': 'both'
          });
        });
        
        // Update pagination info
        const info = table.page.info();
        console.log(`üìä Page ${info.page + 1} of ${info.pages} | Total: ${info.recordsTotal} records`);
      }
    });

    // ============================================
    // ROW CLICK TO EXPAND DETAIL
    // ============================================
    $('#usersTable tbody').on('click', 'tr', function(e) {
      // Don't expand when clicking action buttons
      if ($(e.target).closest('.btn-action, a, button').length > 0) {
        return;
      }

      const row = table.row(this);
      
      if (row.child.isShown()) {
        // Close the row
        row.child.hide();
        $(this).removeClass('shown');
      } else {
        // Close other open rows
        table.rows().every(function() {
          if (this.child.isShown()) {
            this.child.hide();
            $(this.node()).removeClass('shown');
          }
        });

        // Open this row
        const data = row.data();
        row.child(formatUserDetails(data)).show();
        $(this).addClass('shown');
        
        // Animate child row
        $(row.child()).find('.detail-card').css({
          'animation': 'slideDown 0.4s ease-out'
        });
      }
    });

    // ============================================
    // FORMAT FUNCTION FOR ROW DETAILS
    // ============================================
    function formatUserDetails(data) {
      // Extract data from table row
      const username = $(data[1]).text().trim() || data[1].replace(/<[^>]*>/g, '').trim();
      const nama = data[2];
      const npm = data[3];
      const email = data[4];
      const no_hp = data[5];
      const roleBadge = data[6];
      const role = roleBadge.includes('Admin') ? 'Administrator' : 'User';
      const roleIcon = roleBadge.includes('Admin') ? 'crown' : 'user';
      const lastUpdate = data[7];
      
      return `
        <div class="detail-card">
          <div class="detail-header">
            <div class="detail-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="detail-header-info">
              <h5 class="detail-name">${nama}</h5>
              <span class="detail-role badge-glass badge-${roleBadge.includes('Admin') ? 'red' : 'blue'}">
                <i class="fas fa-${roleIcon}"></i> ${role}
              </span>
            </div>
          </div>
          
          <div class="detail-body">
            <div class="detail-section">
              <h6><i class="fas fa-id-card"></i> Informasi Personal</h6>
              <div class="detail-grid">
                <div class="detail-item">
                  <strong>Username:</strong>
                  <span>${username}</span>
                </div>
                <div class="detail-item">
                  <strong>NPM:</strong>
                  <span>${npm}</span>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h6><i class="fas fa-address-card"></i> Kontak</h6>
              <div class="detail-grid">
                <div class="detail-item">
                  <strong>Email:</strong>
                  <span>${email}</span>
                </div>
                <div class="detail-item">
                  <strong>No. HP:</strong>
                  <span>${no_hp}</span>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h6><i class="fas fa-clock"></i> Aktivitas</h6>
              <div class="detail-item">
                <strong>Terakhir Update:</strong>
                <span>${lastUpdate}</span>
              </div>
            </div>
          </div>
          
          <div class="detail-footer">
            <p class="detail-hint">
              <i class="fas fa-info-circle"></i>
              Klik baris lagi untuk menutup detail
            </p>
          </div>
        </div>
      `;
    }

    // ============================================
    // CUSTOM STYLING INJECTION
    // ============================================
    const customStyle = document.createElement('style');
    customStyle.textContent = `
      /* Fade In Row Animation */
      @keyframes fadeInRow {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Slide Down Animation */
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* DataTable Wrapper */
      .datatable-wrapper {
        width: 100%;
      }
      
      /* Top Section */
      .datatable-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(30, 58, 138, 0.1);
      }
      
      .datatable-top-left {
        flex: 0 0 auto;
      }
      
      .datatable-top-center {
        flex: 1 1 auto;
        display: flex;
        justify-content: center;
        gap: 8px;
      }
      
      .datatable-top-right {
        flex: 0 0 auto;
        min-width: 250px;
      }
      
      /* Length Select */
      .dt-length-select {
        padding: 10px 36px 10px 14px;
        border: 2px solid rgba(30, 58, 138, 0.2);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        font-weight: 600;
        color: #1F2937;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%231E3A8A' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px 12px;
      }
      
      .dt-length-select:focus {
        outline: none;
        border-color: #DC143C;
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
      }
      
      /* Search Input */
      .dt-search-input {
        width: 100%;
        padding: 10px 16px 10px 42px;
        border: 2px solid rgba(30, 58, 138, 0.2);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        font-weight: 500;
        color: #1F2937;
        transition: all 0.3s ease;
      }
      
      .dt-search-input:focus {
        outline: none;
        border-color: #DC143C;
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        background: white;
      }
      
      .dataTables_filter {
        position: relative;
      }
      
      .dataTables_filter::before {
        content: "\\f002";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
        z-index: 1;
      }
      
      .dataTables_filter label {
        display: block;
        width: 100%;
        margin: 0;
      }
      
      /* Export Buttons */
      .btn-export {
        padding: 10px 18px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: white !important;
        font-size: 13px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }
      
      .btn-excel {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      }
      
      .btn-pdf {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      }
      
      .btn-print {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      }
      
      .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      }
      
      /* Table Wrapper */
      .datatable-table-wrapper {
        overflow-x: auto;
        margin-bottom: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      
      /* Bottom Section */
      .datatable-bottom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        padding-top: 20px;
        border-top: 2px solid rgba(30, 58, 138, 0.1);
      }
      
      .datatable-bottom-left {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }
      
      .datatable-bottom-right {
        display: flex;
        gap: 4px;
      }
      
      /* Pagination */
      .dataTables_paginate .paginate_button {
        padding: 8px 14px !important;
        margin: 0 2px !important;
        border-radius: 10px !important;
        border: 2px solid rgba(30, 58, 138, 0.2) !important;
        background: rgba(255, 255, 255, 0.95) !important;
        color: #1F2937 !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
      }
      
      .dataTables_paginate .paginate_button:hover {
        background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%) !important;
        color: white !important;
        border-color: transparent !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
      }
      
      .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%) !important;
        color: white !important;
        border-color: transparent !important;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
      }
      
      .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed !important;
        pointer-events: none;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .datatable-top {
          flex-direction: column;
        }
        
        .datatable-top-left,
        .datatable-top-center,
        .datatable-top-right {
          width: 100%;
        }
        
        .datatable-top-center {
          justify-content: flex-start;
          flex-wrap: wrap;
        }
        
        .btn-export {
          flex: 1;
          justify-content: center;
          min-width: calc(50% - 4px);
        }
        
        .datatable-bottom {
          flex-direction: column;
          text-align: center;
        }
        
        .datatable-bottom-right {
          width: 100%;
          justify-content: center;
          flex-wrap: wrap;
        }
      }
    `;
    document.head.appendChild(customStyle);
  });

  // ============================================
  // HELPER FUNCTIONS
  // ============================================
  function confirmDelete(id) {
    if (confirm('‚ùå Apakah Anda yakin ingin menghapus data ini?\n\nData yang dihapus tidak dapat dikembalikan.')) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/dashboard/delete/${id}?_method=DELETE`;
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>
</body>
</html>
