<!-- =========================
     TABLE.EJS (Dashboard - versi baru, sinkron dgn script.ejs)
     ========================= -->
<style>
  /* Toolbar ringkas agar tidak ketiban CSS global */
  .table-toolbar {
    display:flex; justify-content:space-between; align-items:center;
    gap:16px; margin-bottom:24px; flex-wrap:wrap; padding:20px;
    background:rgba(255,255,255,0.9); backdrop-filter:blur(10px);
    border-radius:16px; border:1px solid rgba(30,58,138,0.1);
  }
  .toolbar-left{ display:flex; align-items:center; gap:12px; }
  .toolbar-label{ font-weight:600; color:#374151; font-size:14px; }
  .toolbar-select{
    background:rgba(255,255,255,0.95); border:2px solid #E5E7EB; border-radius:12px;
    padding:10px 16px; font-size:14px; color:#1F2937; font-weight:600; min-width:140px;
    transition:.3s; cursor:pointer;
  }
  .toolbar-select:hover{ border-color:#1E3A8A; }
  .toolbar-select:focus{ outline:none; border-color:#1E3A8A; box-shadow:0 0 0 3px rgba(30,58,138,0.1); }

  .toolbar-right{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .toolbar-search{
    background:rgba(255,255,255,0.95); border:2px solid #E5E7EB; border-radius:12px;
    padding:10px 16px; font-size:14px; color:#1F2937; min-width:250px; transition:.3s;
  }
  .toolbar-search:focus{ outline:none; border-color:#1E3A8A; box-shadow:0 0 0 3px rgba(30,58,138,0.1); }
  .toolbar-search::placeholder{ color:#9CA3AF; }

  .btn-glass{
    background:rgba(255,255,255,0.95); border:2px solid #1E3A8A; color:#1E3A8A;
    border-radius:12px; padding:10px 20px; font-weight:600; transition:.3s;
    display:inline-flex; align-items:center; gap:8px; cursor:pointer;
  }
  .btn-glass:hover{ background:#1E3A8A; color:#fff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(30,58,138,.3); }

  #exportButtons{ display:flex; gap:8px; }
  .dt-btn-green{
    background:linear-gradient(135deg,#10B981 0%,#059669 100%) !important; color:#fff !important;
    border:none !important; border-radius:12px !important; padding:10px 16px !important; font-weight:600 !important;
    display:inline-flex !important; gap:8px !important; box-shadow:0 4px 12px rgba(16,185,129,.3) !important;
  }
  .dt-btn-green:hover{ transform:translateY(-2px) !important; box-shadow:0 6px 16px rgba(16,185,129,.4) !important; }

  /* Detail row */
  #usersTable tbody tr.clickable-row{ cursor:pointer; transition:.3s; }
  #usersTable tbody tr.clickable-row:hover{ background:rgba(30,58,138,.05); }
  #usersTable tbody tr.shown{ background:rgba(220,20,60,.05) !important; }

  .dt-detail{ padding:24px; background:#F9FAFB; animation:fadeInUp .4s ease-out; }
  .detail-card{
    background:#fff; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,.08);
    display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:16px;
  }
  .detail-item{ background:#F9FAFB; padding:16px; border-radius:12px; border-left:4px solid #DC143C; }
  .detail-item b{ display:block; font-size:12px; font-weight:700; color:#6B7280; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
  .detail-item span{ font-size:14px; font-weight:600; color:#1F2937; word-wrap:break-word; }
  .detail-actions{ display:flex; gap:12px; padding-top:20px; border-top:2px solid #E5E7EB; grid-column:1 / -1; }

  @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

  @media (max-width:768px){
    .table-toolbar{ flex-direction:column; align-items:stretch; }
    .toolbar-left,.toolbar-right{ width:100%; justify-content:space-between; }
    .toolbar-search{ min-width:100%; }
    .detail-card{ grid-template-columns:1fr; }
  }
</style>

<!-- TOOLBAR ATAS -->
<div class="table-toolbar">
  <div class="toolbar-left">
    <span class="toolbar-label">Tampilkan</span>
    <select id="itemsPerPage" class="toolbar-select" aria-label="Items per page" style="display:inline-block !important;">
      <option value="10" selected>10 / page</option>
      <option value="25">25 / page</option>
      <option value="50">50 / page</option>
      <option value="100">100 / page</option>
      <option value="-1">Show All</option>
    </select>
  </div>

  <div class="toolbar-right">
    <input id="searchNama" class="toolbar-search" type="search" placeholder="ðŸ” Cari Nama..." aria-label="Cari Nama" style="display:block !important;">
    <button id="btnRefresh" type="button" class="btn-glass">
      <i class="fas fa-sync-alt" aria-hidden="true"></i>
      Refresh
    </button>
    <div id="exportButtons" aria-label="Export Buttons"></div>
  </div>
</div>

<!-- TABEL -->
<div class="table-responsive" style="overflow:visible">
  <table id="usersTable" class="display nowrap table-glass" style="width:100%">
    <thead>
      <tr>
        <th style="width:60px; text-align:center;">No</th>
        <th>Username</th>
        <th>Nama</th>
        <th>NPM</th>
        <th>Email</th>
        <th>Telepon</th>
        <th style="text-align:center;">Role</th>
        <th>Terakhir Update</th>
        <th class="no-sort" style="text-align:center; width:120px;">Aksi</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach(function(u, i){ %>
        <% 
          // Fallback berlapis: cocokkan dgn arsip awal yang pakai 'time'
          const __lastUpdate = u.updatedAt || u.time || u.updated_at || u.lastUpdate || u.updated || u.createdAt;
          const __ts = __lastUpdate ? new Date(__lastUpdate).getTime() : 0;
          function fmtID(d){ try { return new Date(d).toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric' }) } catch(e){ return '-' } }
        %>
        <tr
          class="clickable-row"
          data-id="<%= u._id %>"
          data-username="<%= u.username || '' %>"
          data-nama="<%= u.nama || '' %>"
          data-npm="<%= u.npm || '' %>"
          data-email="<%= u.email || '' %>"
          data-hp="<%= u.hp || '' %>"
          data-ttl="<%= u.ttl || '' %>"
          data-tgl="<%= u.tgl || '' %>"
          data-agama="<%= u.agama || '' %>"
          data-goldar="<%= u.goldar || '' %>"
          data-rumah="<%= u.rumah || '' %>"
          data-kos="<%= u.kos || '' %>"
          data-pendidikan="<%= u.pendidikan || '' %>"
          data-panitia="<%= u.panitia || '' %>"
          data-organisasi="<%= u.organisasi || '' %>"
          data-pelatihan="<%= u.pelatihan || '' %>"
          data-prestasi="<%= u.prestasi || '' %>"
        >
          <td style="text-align:center;"><%= i + 1 %></td>
          <td><strong><%= u.username %></strong></td>
          <td><%= u.nama || '-' %></td>
          <td><%= u.npm || '-' %></td>
          <td><%= u.email || '-' %></td>
          <td><%= u.hp || '-' %></td>
          <td style="text-align:center;">
            <span class="badge-glass <%= (u.role === 'Admin' || u.role === 'admin') ? 'badge-red' : 'badge-blue' %>">
              <i class="fas fa-<%= (u.role === 'Admin' || u.role === 'admin') ? 'user-shield' : 'user' %>"></i>
              <%= (u.role ? (u.role === 'admin' ? 'Admin' : u.role) : 'User') %>
            </span>
          </td>
          <!-- Pakai hidden timestamp utk sorting stabil + tampilkan date lokal -->
          <td data-time="<%= __lastUpdate || '' %>">
            <span class="dt-order" style="display:none;"><%= __ts %></span>
            <%= __lastUpdate ? fmtID(__lastUpdate) : '-' %>
          </td>
          <td class="no-detail" style="text-align:center;" onclick="event.stopPropagation()">
            <a class="btn-action btn-edit" title="Edit" href="/dashboard/edit/<%= u._id %>">
              <i class="fas fa-pen" aria-hidden="true"></i>
            </a>
            <form action="/dashboard/delete/<%= u._id %>?_method=DELETE" method="POST" style="display:inline">
              <button type="submit" class="btn-action btn-delete" title="Hapus"
                      onclick="return confirm('Hapus data <%= u.nama || u.username %>?')">
                <i class="fas fa-trash" aria-hidden="true"></i>
              </button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
