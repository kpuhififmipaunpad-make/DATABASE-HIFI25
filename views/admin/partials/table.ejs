<!-- ============================================
     HIFI Database - Admin Table (FIXED)
     Professional DataTable with Responsive Design
     ============================================ -->

<div class="glass-card">
  <!-- Table Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="text-gradient mb-1">
        <i class="fas fa-users"></i> Data Warga HIFI
      </h4>
      <p class="text-muted mb-0" style="font-size: 14px;">
        Total: <strong id="totalUsers"><%= users.length %></strong> warga terdaftar
      </p>
    </div>
    <div class="d-flex gap-2">
      <button onclick="HIFIAdmin.refreshData()" class="btn-glass" id="refreshBtn" title="Refresh Data">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <a href="/dashboard/tambah" class="btn-primary-gradient">
        <i class="fas fa-plus"></i> Tambah Data
      </a>
    </div>
  </div>

  <!-- DataTable Wrapper -->
  <div class="table-responsive">
    <table id="usersTable" class="table table-hover table-glass" style="width:100%">
      <thead>
        <tr>
          <th style="width: 5%;">No</th>
          <th style="width: 20%;">Nama Lengkap</th>
          <th style="width: 15%;">NPM</th>
          <th style="width: 20%;">Email</th>
          <th style="width: 15%;">No. HP</th>
          <th style="width: 15%;">Alamat Kos</th>
          <th style="width: 10%;" class="no-export text-center">Aksi</th>
        </tr>
      </thead>
      <tbody>
        <% if(users && users.length > 0) { %>
          <% users.forEach((user, index) => { %>
            <tr>
              <td class="text-center"><%= index + 1 %></td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar me-2" style="background: linear-gradient(135deg, #DC143C, #1E3A8A); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">
                    <%= user.nama_lengkap ? user.nama_lengkap.charAt(0).toUpperCase() : 'U' %>
                  </div>
                  <div>
                    <strong><%= user.nama_lengkap || '-' %></strong>
                    <br>
                    <small class="text-muted"><%= user.tempat_lahir || '-' %></small>
                  </div>
                </div>
              </td>
              <td><strong><%= user.npm || '-' %></strong></td>
              <td>
                <i class="fas fa-envelope text-muted me-1"></i>
                <%= user.email || '-' %>
              </td>
              <td>
                <i class="fas fa-phone text-muted me-1"></i>
                <%= user.no_hp || '-' %>
              </td>
              <td>
                <i class="fas fa-map-marker-alt text-muted me-1"></i>
                <%= user.alamat_kos ? (user.alamat_kos.length > 30 ? user.alamat_kos.substring(0, 30) + '...' : user.alamat_kos) : '-' %>
              </td>
              <td class="text-center no-export">
                <div class="d-flex justify-content-center gap-1">
                  <button class="btn-action btn-view" onclick="viewUserDetails('<%= user._id %>')" title="Lihat Detail">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-action btn-edit" onclick="HIFIAdmin.editUser('<%= user._id %>')" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-action btn-delete" onclick="HIFIAdmin.deleteUser('<%= user._id %>')" title="Hapus">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7" class="text-center">
              <div class="empty-state py-5">
                <div class="empty-state-icon">
                  <i class="fas fa-users-slash"></i>
                </div>
                <div class="empty-state-title">Belum Ada Data</div>
                <div class="empty-state-text">Silakan tambahkan data warga HIFI terlebih dahulu</div>
                <a href="/dashboard/tambah" class="btn-primary-gradient mt-3">
                  <i class="fas fa-plus"></i> Tambah Data Pertama
                </a>
              </div>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="modal-overlay" style="display: none;">
  <div class="modal-glass">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="text-gradient mb-0">
        <i class="fas fa-user-circle"></i> Detail Warga
      </h5>
      <button onclick="closeUserDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7280;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="userDetailContent">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>
</div>

<script>
// View User Details Function
function viewUserDetails(userId) {
  const modal = document.getElementById('userDetailModal');
  const content = document.getElementById('userDetailContent');
  
  if (!modal || !content) return;
  
  // Show modal
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  
  // Show loading
  content.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner mx-auto"></div>
      <p class="mt-3 text-muted">Memuat data...</p>
    </div>
  `;
  
  // Fetch user data
  fetch('/dashboard/user/' + userId)
    .then(response => response.json())
    .then(user => {
      content.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <h6 class="text-gradient mb-3">
              <i class="fas fa-user"></i> Informasi Personal
            </h6>
            <table class="table table-borderless">
              <tr>
                <td width="40%"><strong>Nama Lengkap</strong></td>
                <td>: ${user.nama_lengkap || '-'}</td>
              </tr>
              <tr>
                <td><strong>NPM</strong></td>
                <td>: ${user.npm || '-'}</td>
              </tr>
              <tr>
                <td><strong>Tempat Lahir</strong></td>
                <td>: ${user.tempat_lahir || '-'}</td>
              </tr>
              <tr>
                <td><strong>Tanggal Lahir</strong></td>
                <td>: ${user.tanggal_lahir || '-'}</td>
              </tr>
              <tr>
                <td><strong>Agama</strong></td>
                <td>: ${user.agama || '-'}</td>
              </tr>
              <tr>
                <td><strong>Golongan Darah</strong></td>
                <td>: ${user.golongan_darah || '-'}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6 mb-3">
            <h6 class="text-gradient mb-3">
              <i class="fas fa-address-book"></i> Kontak & Alamat
            </h6>
            <table class="table table-borderless">
              <tr>
                <td width="40%"><strong>No. HP</strong></td>
                <td>: ${user.no_hp || '-'}</td>
              </tr>
              <tr>
                <td><strong>Email</strong></td>
                <td>: ${user.email || '-'}</td>
              </tr>
              <tr>
                <td><strong>Alamat Rumah</strong></td>
                <td>: ${user.alamat_rumah || '-'}</td>
              </tr>
              <tr>
                <td><strong>Alamat Kos</strong></td>
                <td>: ${user.alamat_kos || '-'}</td>
              </tr>
            </table>
          </div>
          <div class="col-12">
            <h6 class="text-gradient mb-3">
              <i class="fas fa-history"></i> Riwayat
            </h6>
            <table class="table table-borderless">
              <tr>
                <td width="20%"><strong>Pendidikan</strong></td>
                <td>: ${user.riwayat_pendidikan || '-'}</td>
              </tr>
              <tr>
                <td><strong>Organisasi</strong></td>
                <td>: ${user.riwayat_organisasi || '-'}</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-end mt-4">
          <button onclick="closeUserDetailModal()" class="btn-glass">
            <i class="fas fa-times"></i> Tutup
          </button>
          <button onclick="HIFIAdmin.editUser('${user._id}')" class="btn-primary-gradient">
            <i class="fas fa-edit"></i> Edit Data
          </button>
        </div>
      `;
    })
    .catch(error => {
      console.error('Error:', error);
      content.innerHTML = `
        <div class="alert-glass alert-error">
          <i class="fas fa-exclamation-circle"></i>
          Gagal memuat data. Silakan coba lagi.
        </div>
      `;
    });
}

function closeUserDetailModal() {
  const modal = document.getElementById('userDetailModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Close modal when clicking outside
document.getElementById('userDetailModal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    closeUserDetailModal();
  }
});
</script>

<style>
/* Additional table styling */
#usersTable {
  border-collapse: separate;
  border-spacing: 0;
}

#usersTable thead th {
  background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  padding: 16px;
  border: none;
  position: sticky;
  top: 0;
  z-index: 10;
}

#usersTable tbody td {
  padding: 12px 16px;
  vertical-align: middle;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  color: #374151;
}

#usersTable tbody tr {
  transition: all 0.3s ease;
  cursor: pointer;
}

#usersTable tbody tr:hover {
  background: rgba(30, 58, 138, 0.05);
  transform: translateX(2px);
}

#usersTable tbody tr.shown {
  background: rgba(220, 20, 60, 0.05);
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  flex-shrink: 0;
}

.me-2 {
  margin-right: 8px;
}

/* DataTable Controls Styling */
.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_filter {
  margin-bottom: 0;
}

.dataTables_wrapper .dataTables_length label,
.dataTables_wrapper .dataTables_filter label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 0;
  font-weight: 500;
  color: #374151;
}

.dataTables_wrapper .dt-buttons {
  display: flex;
  gap: 8px;
}

.dataTables_wrapper .top-controls {
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.dataTables_wrapper .bottom-controls {
  padding-top: 16px;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

/* Modal Styling */
#userDetailModal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  padding: 20px;
}

#userDetailModal .modal-glass {
  position: relative;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
}

#userDetailModal .table-borderless td {
  padding: 8px 0;
  font-size: 14px;
  color: #374151;
}

#userDetailModal .table-borderless strong {
  color: #1F2937;
}

/* Responsive */
@media (max-width: 768px) {
  #usersTable thead {
    display: none;
  }
  
  #usersTable tbody td {
    display: block;
    text-align: left;
    padding: 8px 16px;
  }
  
  #usersTable tbody td:first-child {
    padding-top: 16px;
    font-weight: 700;
    background: rgba(30, 58, 138, 0.05);
  }
  
  #usersTable tbody td:last-child {
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }
  
  #usersTable tbody td:before {
    content: attr(data-label);
    font-weight: 700;
    display: inline-block;
    width: 120px;
    color: #1E3A8A;
  }
}
</style>
