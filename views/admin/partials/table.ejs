<style>
  /* =========================================================
     TOOLBAR STYLING
     ========================================================= */
  .table-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(30, 58, 138, 0.1);
  }
  
  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .toolbar-label {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
  }
  
  .toolbar-select {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #E5E7EB;
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 14px;
    color: #1F2937;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
  }
  
  .toolbar-select:hover {
    border-color: #1E3A8A;
  }
  
  .toolbar-select:focus {
    outline: none;
    border-color: #1E3A8A;
    box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
  }
  
  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .toolbar-search {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #E5E7EB;
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 14px;
    color: #1F2937;
    transition: all 0.3s ease;
    min-width: 250px;
  }
  
  .toolbar-search:focus {
    outline: none;
    border-color: #1E3A8A;
    box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
  }
  
  .toolbar-search::placeholder {
    color: #9CA3AF;
  }
  
  .btn-glass {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #1E3A8A;
    color: #1E3A8A;
    border-radius: 12px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-glass:hover {
    background: #1E3A8A;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
  }
  
  /* Export Buttons Container */
  #exportButtons {
    display: flex;
    gap: 8px;
  }
  
  /* DataTables Buttons - Green Theme */
  .dt-button {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
    color: white !important;
    border: none !important;
    border-radius: 12px !important;
    padding: 10px 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
  }
  
  .dt-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
  }
  
  /* =========================================================
     PAGINATION STYLING
     ========================================================= */
  .dataTables_wrapper .dataTables_paginate {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid rgba(0, 0, 0, 0.05);
  }
  
  .dataTables_wrapper .dataTables_info {
    color: #374151;
    font-weight: 600;
    font-size: 14px;
    padding: 12px 0;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 2px solid #E5E7EB !important;
    border-radius: 10px !important;
    color: #374151 !important;
    padding: 8px 14px !important;
    margin: 0 4px !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: rgba(30, 58, 138, 0.1) !important;
    color: #1E3A8A !important;
    border-color: #1E3A8A !important;
    transform: translateY(-2px) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%) !important;
    color: white !important;
    border: none !important;
    box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3) !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    background: rgba(255, 255, 255, 0.5) !important;
  }
  
  /* =========================================================
     DETAIL ROW (PREVIEW BIODATA)
     ========================================================= */
  #usersTable tbody tr {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  #usersTable tbody tr:hover {
    background: rgba(30, 58, 138, 0.05);
    transform: scale(1.005);
  }
  
  #usersTable tbody tr.shown {
    background: rgba(220, 20, 60, 0.05);
  }
  
  .detail-row {
    background: rgba(249, 250, 251, 0.95);
    animation: fadeInUp 0.4s ease-out;
  }
  
  .detail-content {
    padding: 24px;
    background: white;
    border-radius: 16px;
    margin: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  
  .detail-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #E5E7EB;
  }
  
  .detail-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 32px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
  }
  
  .detail-info {
    flex: 1;
  }
  
  .detail-name {
    font-size: 24px;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 4px;
  }
  
  .detail-npm {
    font-size: 16px;
    color: #6B7280;
    font-weight: 600;
  }
  
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .detail-item {
    background: #F9FAFB;
    padding: 16px;
    border-radius: 12px;
    border-left: 4px solid #DC143C;
  }
  
  .detail-label {
    font-size: 12px;
    font-weight: 700;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .detail-value {
    font-size: 14px;
    font-weight: 600;
    color: #1F2937;
    word-wrap: break-word;
  }
  
  .detail-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 2px solid #E5E7EB;
  }
  
  .btn-detail-edit {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .btn-detail-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
  }
  
  .btn-detail-close {
    background: rgba(107, 114, 128, 0.1);
    color: #374151;
    border: 2px solid #9CA3AF;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-detail-close:hover {
    background: rgba(107, 114, 128, 0.2);
    transform: scale(1.02);
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* =========================================================
     RESPONSIVE
     ========================================================= */
  @media (max-width: 768px) {
    .table-toolbar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .toolbar-left,
    .toolbar-right {
      width: 100%;
      justify-content: space-between;
    }
    
    .toolbar-search {
      min-width: 100%;
    }
    
    .detail-grid {
      grid-template-columns: 1fr;
    }
    
    .detail-header {
      flex-direction: column;
      text-align: center;
    }
  }
</style>

<div class="table-container">
  <!-- TOOLBAR ATAS -->
  <div class="table-toolbar">
    <div class="toolbar-left">
      <span class="toolbar-label">Tampilkan</span>
      <select id="itemsPerPage" class="toolbar-select" aria-label="Items per page">
        <option value="10" selected>10 / page</option>
        <option value="25">25 / page</option>
        <option value="50">50 / page</option>
        <option value="100">100 / page</option>
      </select>
    </div>

    <div class="toolbar-right">
      <input id="searchNama" class="toolbar-search" type="search" placeholder="ðŸ” Cari Nama..." />
      <button id="btnRefresh" type="button" class="btn-glass">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
      <div id="exportButtons"></div>
    </div>
  </div>

  <!-- TABEL -->
  <table id="usersTable" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>No</th>
        <th>Username</th>
        <th>Nama</th>
        <th>NPM</th>
        <th>Email</th>
        <th>Telepon</th>
        <th>Role</th>
        <th>Terakhir Update</th>
        <th class="no-sort">Aksi</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach(function(u, i){ %>
        <tr
          class="clickable-row"
          data-id="<%= u._id %>"
          data-username="<%= u.username || '' %>"
          data-nama="<%= u.nama || '' %>"
          data-npm="<%= u.npm || '' %>"
          data-email="<%= u.email || '' %>"
          data-hp="<%= u.hp || '' %>"
          data-ttl="<%= u.ttl || '' %>"
          data-tgl="<%= u.tgl || '' %>"
          data-agama="<%= u.agama || '' %>"
          data-goldar="<%= u.goldar || '' %>"
          data-rumah="<%= u.rumah || '' %>"
          data-kos="<%= u.kos || '' %>"
          data-pendidikan="<%= u.pendidikan || '' %>"
          data-panitia="<%= u.panitia || '' %>"
          data-organisasi="<%= u.organisasi || '' %>"
          data-pelatihan="<%= u.pelatihan || '' %>"
          data-prestasi="<%= u.prestasi || '' %>"
        >
          <td><%= i + 1 %></td>
          <td><%= u.username %></td>
          <td><%= u.nama || '-' %></td>
          <td><%= u.npm || '-' %></td>
          <td><%= u.email || '-' %></td>
          <td><%= u.hp || '-' %></td>
          <td>
            <span class="badge-glass">
              <i class="fas fa-<%= (u.role === 'Admin') ? 'user-shield' : 'user' %>"></i>
              <%= (u.role || 'User') %>
            </span>
          </td>
          <td><%= u.updatedAt ? new Date(u.updatedAt).toLocaleDateString('id-ID') : '-' %></td>
          <td class="no-detail" onclick="event.stopPropagation()">
            <a class="btn-action btn-edit" title="Edit" href="/dashboard/edit/<%= u._id %>">
              <i class="fas fa-pen"></i>
            </a>
            <form action="/dashboard/delete/<%= u._id %>?_method=DELETE" method="POST" style="display:inline">
              <button type="submit" class="btn-action btn-delete" title="Hapus" onclick="return confirm('Hapus data <%= u.nama || u.username %>?')">
                <i class="fas fa-trash"></i>
              </button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>
  $(document).ready(function() {
    // Initialize DataTable
    var table = $('#usersTable').DataTable({
      responsive: false,
      pageLength: 10,
      lengthChange: false,
      searching: true,
      ordering: true,
      info: true,
      autoWidth: false,
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'excelHtml5',
          text: '<i class="fas fa-file-excel"></i> Excel',
          className: 'dt-button',
          title: 'Data Warga HIFI',
          exportOptions: {
            columns: [0, 1, 2, 3, 4, 5, 6, 7]
          }
        },
        {
          extend: 'pdfHtml5',
          text: '<i class="fas fa-file-pdf"></i> PDF',
          className: 'dt-button',
          title: 'Data Warga HIFI',
          exportOptions: {
            columns: [0, 1, 2, 3, 4, 5, 6, 7]
          }
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print"></i> Print',
          className: 'dt-button',
          title: 'Data Warga HIFI',
          exportOptions: {
            columns: [0, 1, 2, 3, 4, 5, 6, 7]
          }
        }
      ],
      columnDefs: [
        { targets: 'no-sort', orderable: false }
      ],
      language: {
        paginate: {
          first: 'Â«',
          previous: 'â€¹',
          next: 'â€º',
          last: 'Â»'
        },
        info: 'Menampilkan _START_ - _END_ dari _TOTAL_ data',
        infoEmpty: 'Tidak ada data',
        infoFiltered: '(disaring dari _MAX_ total data)',
        zeroRecords: 'Data tidak ditemukan',
        emptyTable: 'Tidak ada data tersedia'
      }
    });
    
    // Move buttons to custom container
    table.buttons().container().appendTo('#exportButtons');
    
    // Custom search
    $('#searchNama').on('keyup', function() {
      table.column(2).search(this.value).draw();
    });
    
    // Items per page
    $('#itemsPerPage').on('change', function() {
      var val = parseInt(this.value);
      table.page.len(val).draw();
    });
    
    // Refresh button
    $('#btnRefresh').on('click', function() {
      var btn = $(this);
      btn.find('i').addClass('fa-spin');
      location.reload();
    });
    
    // Row click to show detail
    var expandedRow = null;
    
    $('#usersTable tbody').on('click', 'tr.clickable-row', function(e) {
      // Jangan toggle jika klik di kolom aksi
      if ($(e.target).closest('.no-detail').length > 0) {
        return;
      }
      
      var tr = $(this);
      var row = table.row(tr);
      
      // Close previous expanded row
      if (expandedRow !== null && expandedRow !== row) {
        expandedRow.child.hide();
        $(expandedRow.node()).removeClass('shown');
      }
      
      if (row.child.isShown()) {
        // Close this row
        row.child.hide();
        tr.removeClass('shown');
        expandedRow = null;
      } else {
        // Open this row
        row.child(formatDetail(tr)).show();
        tr.addClass('shown');
        expandedRow = row;
      }
    });
    
    // Format detail row
    function formatDetail(tr) {
      var data = tr.data();
      var nama = data.nama || '-';
      var npm = data.npm || '-';
      var username = data.username || '-';
      var email = data.email || '-';
      var hp = data.hp || '-';
      var ttl = data.ttl || '-';
      var tgl = data.tgl || '-';
      var agama = data.agama || '-';
      var goldar = data.goldar || '-';
      var rumah = data.rumah || '-';
      var kos = data.kos || '-';
      var pendidikan = data.pendidikan || '-';
      var panitia = data.panitia || '-';
      var organisasi = data.organisasi || '-';
      var pelatihan = data.pelatihan || '-';
      var prestasi = data.prestasi || '-';
      var id = data.id;
      
      // Get initials for avatar
      var initials = nama !== '-' ? nama.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : username[0].toUpperCase();
      
      return `
        <div class="detail-content">
          <div class="detail-header">
            <div class="detail-avatar">${initials}</div>
            <div class="detail-info">
              <div class="detail-name">${nama}</div>
              <div class="detail-npm">NPM: ${npm}</div>
            </div>
          </div>
          
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-user"></i> Username
              </div>
              <div class="detail-value">${username}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-envelope"></i> Email
              </div>
              <div class="detail-value">${email}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-phone"></i> No. HP
              </div>
              <div class="detail-value">${hp}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-map-marker-alt"></i> Tempat Lahir
              </div>
              <div class="detail-value">${ttl}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-calendar"></i> Tanggal Lahir
              </div>
              <div class="detail-value">${tgl !== '-' ? new Date(tgl).toLocaleDateString('id-ID') : '-'}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-pray"></i> Agama
              </div>
              <div class="detail-value">${agama}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-tint"></i> Golongan Darah
              </div>
              <div class="detail-value">${goldar}</div>
            </div>
          </div>
          
          <div class="detail-grid" style="grid-template-columns: 1fr;">
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-home"></i> Alamat Rumah
              </div>
              <div class="detail-value">${rumah}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-building"></i> Alamat Kos
              </div>
              <div class="detail-value">${kos}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-graduation-cap"></i> Pendidikan
              </div>
              <div class="detail-value">${pendidikan}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-users"></i> Kepanitiaan
              </div>
              <div class="detail-value">${panitia}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-sitemap"></i> Organisasi
              </div>
              <div class="detail-value">${organisasi}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-certificate"></i> Pelatihan
              </div>
              <div class="detail-value">${pelatihan}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-trophy"></i> Prestasi
              </div>
              <div class="detail-value">${prestasi}</div>
            </div>
          </div>
          
          <div class="detail-actions">
            <a href="/dashboard/edit/${id}" class="btn-detail-edit">
              <i class="fas fa-edit"></i>
              Edit Data Lengkap
            </a>
            <button class="btn-detail-close" onclick="$(this).closest('tr').prev().click()">
              <i class="fas fa-times"></i>
              Tutup
            </button>
          </div>
        </div>
      `;
    }
  });
</script>
