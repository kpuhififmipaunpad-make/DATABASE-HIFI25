<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Table dengan Fitur Lengkap</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- DataTables + Buttons (Bootstrap 5) -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    body { background:#f8f9fa; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .container-fluid { padding:30px; }
    .card{ border:none; border-radius:15px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:30px; }
    .card-header{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border-radius:15px 15px 0 0!important; padding:20px; }
    .card-header h3{ margin:0; font-weight:600; }
    .card-body{ padding:25px; }
    .search-bar{ margin-bottom:20px; }
    .search-bar input{ border-radius:25px; padding:12px 20px; border:2px solid #e0e0e0; transition:.3s; }
    .search-bar input:focus{ border-color:#667eea; box-shadow:0 0 0 .2rem rgba(102,126,234,.25); }
    .export-buttons{ margin-bottom:20px; }
    .btn-export{ border-radius:25px; padding:10px 25px; margin-right:10px; font-weight:500; transition:.3s; border:none; }
    .btn-excel{ background:#28a745; color:#fff; } .btn-excel:hover{ background:#218838; transform:translateY(-2px); box-shadow:0 4px 8px rgba(40,167,69,.3); }
    .btn-pdf{ background:#dc3545; color:#fff; } .btn-pdf:hover{ background:#c82333; transform:translateY(-2px); box-shadow:0 4px 8px rgba(220,53,69,.3); }
    .btn-print{ background:#007bff; color:#fff; } .btn-print:hover{ background:#0056b3; transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,123,255,.3); }
    .table-container{ overflow-x:auto; }
    thead th{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:15px; font-weight:600; position:sticky; top:0; z-index:10; border:none; }
    thead th:first-child{ border-top-left-radius:10px; } thead th:last-child{ border-top-right-radius:10px; }
    tbody tr{ transition:.3s; border-bottom:1px solid #e0e0e0; }
    tbody tr:hover{ background:#f5f7ff; transform:scale(1.01); box-shadow:0 2px 8px rgba(0,0,0,.1); }
    tbody td{ padding:15px; vertical-align:middle; }
    .pagination-container{ display:flex; justify-content:space-between; align-items:center; margin-top:25px; flex-wrap:wrap; gap:12px; }
    .items-per-page{ display:flex; align-items:center; gap:10px; }
    .items-per-page select{ border-radius:8px; padding:8px 15px; border:2px solid #e0e0e0; cursor:pointer; }
    .pagination{ margin:0; }
    .page-link{ border-radius:8px; margin:0 3px; border:2px solid #667eea; color:#667eea; padding:8px 15px; font-weight:500; }
    .page-link:hover{ background:#667eea; color:#fff; }
    .page-item.active .page-link{ background:#667eea; border-color:#667eea; color:#fff; }
    .badge{ padding:6px 12px; border-radius:20px; font-weight:500; }
    @media print{ .no-print{ display:none!important; } .card{ box-shadow:none; } }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-table me-2"></i>Data Table Management</h3>
      </div>

      <div class="card-body">
        <!-- Search Bar -->
        <div class="search-bar no-print">
          <div class="row">
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control border-start-0"
                       placeholder="Cari nama, email, atau nomor telepon…"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Buttons -->
        <div class="export-buttons no-print">
          <button class="btn btn-export btn-excel" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-2"></i>Export Excel
          </button>
          <button class="btn btn-export btn-pdf" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-2"></i>Export PDF
          </button>
          <button class="btn btn-export btn-print" onclick="printTable()">
            <i class="fas fa-print me-2"></i>Print
          </button>
        </div>

        <!-- Table -->
        <div class="table-container">
          <table class="table table-hover" id="usersTable" style="width:100%">
            <thead>
              <tr>
                <th>No</th>
                <th>Username</th>
                <th>Nama</th>
                <th>NPM</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Role</th>
                <th>Terakhir Update</th>
                <th class="no-export no-print">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach((user, index) => { %>
                <tr data-id="<%= user._id %>">
                  <td><%= index + 1 %></td>
                  <td><strong><%= user.username %></strong></td>
                  <td><%= user.nama || '-' %></td>
                  <td><%= user.npm || '-' %></td>
                  <td><%= user.email || '-' %></td>
                  <td><%= user.phone || user.phoneNumber || user.hp || '-' %></td>
                  <td>
                    <span class="badge <%= user.role === 'admin' ? 'bg-danger' : 'bg-primary' %>">
                      <i class="fas fa-<%= user.role === 'admin' ? 'crown' : 'user' %>"></i>
                      <%= user.role === 'admin' ? 'Admin' : 'User' %>
                    </span>
                  </td>
                  <!-- tampil relatif, sort/export pakai ISO -->
                  <td data-rawtime="<%= user.updatedAt || user.time || user.lastUpdate || '' %>">
                    <%= user.updatedAt || user.time || user.lastUpdate || '-' %>
                  </td>
                  <td class="no-export no-print">
                    <button class="btn btn-sm btn-primary"
                            onclick="window.location.href='/dashboard/edit/<%= user._id %>'" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDelete('<%= user._id %>')" title="Hapus">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls (kustom, sinkron ke DataTables) -->
        <div class="pagination-container no-print">
          <div class="items-per-page">
            <label for="itemsPerPage">Items per page:</label>
            <select id="itemsPerPage" onchange="changeItemsPerPage()">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span id="pageInfo"></span>
          </div>
          <nav>
            <ul class="pagination" id="pagination"><!-- diisi via JS --></ul>
          </nav>
        </div>

      </div>
    </div>
  </div>

  <!-- Core JS: jQuery + Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DataTables + Buttons (HTML5 export membutuhkan JSZip & pdfmake) -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <script>
  (() => {
    // ===== helpers
    const libsReady = () =>
      !!window.jQuery && !!$.fn.DataTable && !!$.fn.dataTable && !!$.fn.dataTable.Buttons;

    const whenDOMReady = (cb) => {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", cb, { once:true });
      } else cb();
    };

    const debounce = (fn, wait=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };

    function formatRelativeTime(dateString){
      if(!dateString) return 'Tidak pernah';
      const d = new Date(dateString);
      if(isNaN(d.getTime())) return '—';
      const now = new Date();
      const diffSec = Math.floor((now - d)/1000);
      const abs = Math.abs(diffSec);
      const units = [["tahun",365*24*3600],["bulan",30*24*3600],["hari",24*3600],["jam",3600],["menit",60],["detik",1]];
      for(const [name,sec] of units){
        const v = Math.floor(abs/sec);
        if(v>=1) return diffSec>=0 ? `${v} ${name} yang lalu` : `dalam ${v} ${name}`;
      }
      return "baru saja";
    }

    function normalizeToISO(s){
      if(!s) return null;
      const d1 = new Date(s);
      if(!isNaN(d1.getTime())) return d1.toISOString();
      const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        const [_, dd, mm, yyyy, HH="00", MM="00", SS="00"] = m;
        const year = yyyy.length===2 ? Number("20"+yyyy) : Number(yyyy);
        const iso = new Date(year, Number(mm)-1, Number(dd), Number(HH), Number(MM), Number(SS));
        if(!isNaN(iso.getTime())) return iso.toISOString();
      }
      return null;
    }

    function normalizePhone(text){
      if(!text) return "";
      const only = String(text).replace(/[^0-9+]/g,"");
      return only.replace(/(.*)\+/g,"+$1");
    }

    whenDOMReady(() => {
      if(!libsReady()) return console.error("DataTables/Buttons belum siap.");
      const $table = $("#usersTable");
      if(!$table.length) return;

      const dt = $table.DataTable({
        responsive: true,
        autoWidth: false,
        lengthChange: true,
        paging: true,
        ordering: true,
        searching: false,   // pakai search bar custom
        pageLength: 10,
        dom: "Blrtip",
        language: {
          lengthMenu: "Tampilkan _MENU_ data per halaman",
          info: "Menampilkan _START_–_END_ dari _TOTAL_ data",
          infoEmpty: "Menampilkan 0 data",
          paginate: { previous: "‹", next: "›" },
          zeroRecords: "Tidak ada data yang cocok"
        },
        buttons: [
          { extend:"excelHtml5", title:"Users",
            exportOptions:{ columns:":not(.no-export)", format:{ body: exportBody } } },
          { extend:"pdfHtml5", title:"Users", orientation:"landscape", pageSize:"A4",
            exportOptions:{ columns:":not(.no-export)", format:{ body: exportBody } } },
          { extend:"print", title:"Users",
            exportOptions:{ columns:":not(.no-export)", format:{ body: exportBody } } },
        ],
        order: [[0,"asc"]],
        columnDefs: [
          { targets:0, width:56, type:"num", className:"dt-center" }, // No
          { targets:6, className:"dt-center" },                       // Role
          { // Phone (index 5): sort/export pakai angka bersih
            targets:5,
            render: (data, type) => {
              const text = (data||"").toString();
              if(type==="sort"||type==="type"||type==="export") return normalizePhone(text);
              return text;
            }
          },
          { // Terakhir Update (index 7): display relatif; sort/export ISO
            targets:7,
            render: (data, type, row, meta) => {
              const cell = dt.cell(meta.row, meta.col).node();
              const rawAttr = cell && cell.getAttribute ? cell.getAttribute("data-rawtime") : null;
              const raw = (rawAttr || data || "").toString().trim();
              const iso = normalizeToISO(raw) || raw || "";
              if(type==="display"){
                const title = iso ? new Date(iso).toLocaleString('id-ID') : "";
                const rel = iso ? formatRelativeTime(iso) : "—";
                return `<time datetime="${iso}" title="${title}">${rel}</time>`;
              }
              return iso;
            }
          }
        ],
        drawCallback: function(){
          // refresh waktu relatif
          $table.find("time[datetime]").each(function(){
            const iso = this.getAttribute("datetime");
            if(iso) this.textContent = formatRelativeTime(iso);
          });
          syncItemsPerPageSelect();
          updatePageInfoBridge();
          renderCustomPagination();
        }
      });

      // Taruh tombol export di wrapper kiri
      dt.buttons().container().appendTo('#usersTable_wrapper .col-md-6:eq(0)');

      // ===== Search bar custom (#searchInput)
      const $search = $("#searchInput");
      if($search.length){
        $search.on("input", debounce(function(){
          dt.search(this.value).draw();
        }, 200));
      }

      // ===== Items per page custom
      const $len = $("#itemsPerPage");
      function syncItemsPerPageSelect(){
        if(!$len.length) return;
        const cur = dt.page.len();
        if(String($len.val()) !== String(cur)) $len.val(String(cur));
      }
      if($len.length){
        syncItemsPerPageSelect();
        $len.on("change", function(){
          const n = parseInt(this.value, 10) || 10;
          dt.page.len(n).draw();
        });
      }

      // ===== Page info custom
      const $pageInfo = $("#pageInfo");
      function updatePageInfoBridge(){
        if(!$pageInfo.length) return;
        const info = dt.page.info();
        if(!info) return;
        const start = info.recordsDisplay ? info.start + 1 : 0;
        const end   = info.end;
        const total = info.recordsDisplay;
        $pageInfo.text(`Menampilkan ${start}–${end} dari ${total} data`);
      }
      updatePageInfoBridge();

      // ===== Pagination kustom (sinkron DT)
      const $pagi = $("#pagination");
      function renderCustomPagination(){
        if(!$pagi.length) return;
        const info = dt.page.info();
        const totalPages = info.pages || 0;
        const cur = info.page + 1;
        $pagi.empty();
        if(totalPages <= 1) return;

        // Prev
        $pagi.append(`
          <li class="page-item ${cur===1?'disabled':''}">
            <a href="#" class="page-link" data-page="${cur-1}" aria-label="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>`);

        // windowed pages
        const start = Math.max(1, cur - 2);
        const end   = Math.min(totalPages, cur + 2);

        if(start > 1){
          $pagi.append(`<li class="page-item"><a class="page-link" data-page="1" href="#">1</a></li>`);
          if(start > 2) $pagi.append(`<li class="page-item disabled"><span class="page-link">…</span></li>`);
        }

        for(let i=start;i<=end;i++){
          $pagi.append(`
            <li class="page-item ${i===cur?'active':''}">
              <a class="page-link" data-page="${i}" href="#">${i}</a>
            </li>`);
        }

        if(end < totalPages){
          if(end < totalPages-1) $pagi.append(`<li class="page-item disabled"><span class="page-link">…</span></li>`);
          $pagi.append(`<li class="page-item"><a class="page-link" data-page="${totalPages}" href="#">${totalPages}</a></li>`);
        }

        // Next
        $pagi.append(`
          <li class="page-item ${cur===totalPages?'disabled':''}">
            <a href="#" class="page-link" data-page="${cur+1}" aria-label="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>`);
      }
      renderCustomPagination();

      // Delegasi click
      $pagi.on("click", "a.page-link", function(e){
        e.preventDefault();
        const target = Number(this.getAttribute("data-page"));
        const info = dt.page.info();
        if(isNaN(target)) return;
        const pageIdx = Math.max(0, Math.min(target-1, info.pages-1));
        dt.page(pageIdx).draw('page');
        window.scrollTo({ top:0, behavior:'smooth' });
      });

      // ===== Export wrappers (kompatibel tombol custom)
      window.exportToExcel = () => dt.button('.buttons-excel').trigger();
      window.exportToPDF   = () => dt.button('.buttons-pdf').trigger();
      window.printTable    = () => dt.button('.buttons-print').trigger();

      // ===== ItemsPerPage via function (kompatibilitas)
      window.changeItemsPerPage = function(){
        const el = document.getElementById('itemsPerPage');
        if(!el) return;
        const n = parseInt(el.value, 10) || 10;
        dt.page.len(n).draw();
      };

      // ===== Edit/Delete
      window.confirmDelete = function(id){
        if(!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/delete/${id}?_method=DELETE`;
        document.body.appendChild(form);
        form.submit();
      };

      // ===== Export body formatter
      function exportBody(data, row, col, node){
        if(!node) return data;
        const time = node.querySelector && node.querySelector("time[datetime]");
        if(time) return time.getAttribute("datetime") || "";
        if(col === 5) return normalizePhone(node.textContent || data || "");
        return (node.textContent || data || "").trim();
      }
    });
  })();
  </script>
</body>
</html>
