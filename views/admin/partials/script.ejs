<script>
(() => {
  // ===== helpers: tunggu jQuery + DataTables siap =====
  const libsReady = () =>
    !!window.jQuery &&
    !!$.fn.DataTable &&
    !!$.fn.dataTable &&
    !!$.fn.dataTable.Buttons;

  const whenDOMReady = (cb) => {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", cb, { once: true });
    } else {
      cb();
    }
  };

  const debounce = (fn, wait = 160) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(null, args), wait);
    };
  };

  function boot() {
    if (!libsReady()) {
      console.error("jQuery/DataTables belum siap.");
      return;
    }
    const $table = $("#usersTable");
    if (!$table.length) return;

    // Bersihkan instance/handler lama kalau ada
    try {
      if ($.fn.DataTable.isDataTable($table)) {
        $table.DataTable().destroy(true);
      }
    } catch (_) {}
    $("#searchNama").off(".tbl");
    $("#itemsPerPage").off(".tbl");
    $("#btnRefresh").off(".tbl");
    $table.find("tbody").off(".tbl");

    // Inisialisasi DataTable
    const dt = $table.DataTable({
      // Stabilitas layout
      autoWidth: false,
      scrollX: true,
      scrollCollapse: true,
      deferRender: true,

      // UX
      responsive: false,
      lengthChange: false,     // pakai kontrol custom
      searching: false,        // pakai search custom
      pagingType: "simple_numbers",
      pageLength: 10,

      // Default urutan: kolom No (index 0) → 1..akhir
      // (Jika ingin urut "Terakhir Update" terbaru dulu: ganti ke [[7,'desc']])
      order: [[0, "asc"]],

      dom: "Bt<'dt-bottom'ip>",

      columnDefs: [
        { targets: 0, width: 64, type: "num", className: "dt-col-no dt-center" }, // No
        { targets: 6, width: 120, className: "dt-center" },                       // Role
        {
          targets: 7, // Terakhir Update
          createdCell: function (td) {
            // Tarik nilai waktu mentah dari atribut data-time (di-render EJS):
            // prioritas u.time -> updatedAt -> updated_at -> lastUpdate -> updated -> createdAt
            const raw = td.getAttribute("data-time");
            const ts = raw ? new Date(raw).getTime() : NaN;
            td.setAttribute("data-order", Number.isFinite(ts) ? String(ts) : "-1");
          }
        },
        { targets: 8, width: 120, orderable: false, className: "no-detail dt-center" } // Aksi
      ],

      language: {
        paginate: { first: "«", previous: "‹", next: "›", last: "»" },
        info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
        infoEmpty: "Tidak ada data",
        infoFiltered: "(disaring dari _MAX_ total data)",
        zeroRecords: "Data tidak ditemukan",
        emptyTable: "Tidak ada data tersedia"
      },

      buttons: [
        {
          extend: "excel",
          text: '<i class="fas fa-file-excel"></i> Excel',
          className: "dt-btn-green",
          title: "Data Warga HIFI",
          exportOptions: { columns: [0,1,2,3,4,5,6,7] }
        },
        {
          extend: "pdf",
          text: '<i class="fas fa-file-pdf"></i> PDF',
          className: "dt-btn-green",
          title: "Data Warga HIFI",
          orientation: "landscape",
          exportOptions: { columns: [0,1,2,3,4,5,6,7] }
        },
        {
          extend: "print",
          text: '<i class="fas fa-print"></i> Print',
          className: "dt-btn-green",
          title: "Data Warga HIFI",
          exportOptions: { columns: [0,1,2,3,4,5,6,7] }
        }
      ],

      initComplete: function () {
        // Stabilkan kolom setelah initial paint/font load
        const api = this.api();
        api.columns.adjust();
        requestAnimationFrame(() => api.columns.adjust());
        setTimeout(() => api.columns.adjust(), 120);

        // Pindahkan tombol export ke holder kustom bila ada
        const $holder = $("#exportButtons");
        if ($holder.length) {
          $holder.empty();
          api.buttons().container().appendTo($holder);
        } else {
          api.buttons().container().insertBefore($table);
        }
      },

      drawCallback: function () {
        // Jaga agar tidak melebar saat filter/ubah page length
        const api = this.api();
        api.columns.adjust();
        requestAnimationFrame(() => api.columns.adjust());
      }
    });

    // ======== Search (kolom Nama = index 2) dengan debounce ========
    const onSearch = debounce(function () {
      const val = this.value || "";
      dt.column(2).search(val).draw(false);
      dt.columns.adjust();
      requestAnimationFrame(() => dt.columns.adjust());
    }, 140);
    $("#searchNama").on("input.tbl", onSearch);

    // ======== Items per page ========
    $("#itemsPerPage").on("change.tbl", function () {
      const v = parseInt(this.value, 10);
      dt.page.len(v === -1 ? -1 : v).draw(false);
      dt.columns.adjust();
      requestAnimationFrame(() => dt.columns.adjust());
      setTimeout(() => dt.columns.adjust(), 0);
    });

    // ======== Refresh ========
    $("#btnRefresh").on("click.tbl", function () {
      const $i = $(this).find("i");
      $i.addClass("fa-spin");
      setTimeout(() => location.reload(), 280);
    });

    // ======== Row detail (klik baris) ========
    $table.find("tbody")
      .on("click.tbl", "tr.clickable-row td:not(.no-detail)", function (e) {
        if ($(e.target).closest(".btn-action,button,a,form").length) return;
        const $tr  = $(this).closest("tr.clickable-row");
        const row  = dt.row($tr);
        const ds   = $tr.get(0).dataset;

        if (row.child.isShown()) {
          row.child.hide();
          $tr.removeClass("shown");
        } else {
          dt.rows().every(function () {
            if (this.child && this.child.isShown && this.child.isShown()) {
              this.child.hide();
              $(this.node()).removeClass("shown");
            }
          });
          row.child(buildDetail(ds)).show();
          $tr.addClass("shown");
          dt.columns.adjust();
          requestAnimationFrame(() => dt.columns.adjust());
        }
      });

    // ======== Stabilkan saat resize / tab berubah ========
    window.addEventListener("resize", debounce(() => {
      dt.columns.adjust();
    }, 120));

    // Jika ada Bootstrap tab/collapse, adjust saat tab aktif
    document.addEventListener("shown.bs.tab", () => {
      dt.columns.adjust();
      requestAnimationFrame(() => dt.columns.adjust());
    });
    document.addEventListener("shown.bs.collapse", () => {
      dt.columns.adjust();
      requestAnimationFrame(() => dt.columns.adjust());
    });

    // Ekspos kecil untuk debug
    window.__HIFI__ = window.__HIFI__ || {};
    window.__HIFI__.usersTableInited = true;
    window.__HIFI__.usersDT = dt;

    console.log("✅ DataTable initialized. rows:", dt.rows().count(), "pageLen:", dt.page.len());
  }

  // Tunggu library siap
  (function waitLibs(tries = 0) {
    if (libsReady()) return whenDOMReady(boot);
    if (tries > 120) return console.error("Gagal memuat DataTables/Buttons.");
    setTimeout(() => waitLibs(tries + 1), 50);
  })();
})();
</script>
