<script>
(function () {
  // Pastikan jQuery + DataTables ada
  if (!window.jQuery || !$.fn.DataTable) return;

  // Escape HTML sederhana
  const esc = (v) =>
    (v == null || String(v).trim() === "" ? "-" :
      String(v).replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m])));

  // Template child row â€” disamakan dengan field di edit.ejs
  function buildDetail(ds) {
    return `
      <div class="dt-detail">
        <div class="detail-card">
          <div class="detail-item"><b>Nama Lengkap</b><span>${esc(ds.nama)}</span></div>
          <div class="detail-item"><b>NPM</b><span>${esc(ds.npm)}</span></div>
          <div class="detail-item"><b>Tempat Lahir</b><span>${esc(ds.ttl)}</span></div>
          <div class="detail-item"><b>Tanggal Lahir</b><span>${esc(ds.tgl)}</span></div>
          <div class="detail-item"><b>Agama</b><span>${esc(ds.agama)}</span></div>
          <div class="detail-item"><b>Golongan Darah</b><span>${esc(ds.goldar)}</span></div>
          <div class="detail-item"><b>No. HP</b><span>${esc(ds.hp)}</span></div>
          <div class="detail-item"><b>Email</b><span>${esc(ds.email)}</span></div>

          <div class="detail-item" style="grid-column:1/-1"><b>Alamat Rumah</b><span>${esc(ds.rumah)}</span></div>
          <div class="detail-item" style="grid-column:1/-1"><b>Alamat Kos</b><span>${esc(ds.kos)}</span></div>

          <div class="detail-item" style="grid-column:1/-1"><b>Pendidikan</b><span>${esc(ds.pendidikan)}</span></div>
          <div class="detail-item" style="grid-column:1/-1"><b>Kepanitiaan</b><span>${esc(ds.panitia)}</span></div>
          <div class="detail-item" style="grid-column:1/-1"><b>Organisasi</b><span>${esc(ds.organisasi)}</span></div>
          <div class="detail-item" style="grid-column:1/-1"><b>Pelatihan</b><span>${esc(ds.pelatihan)}</span></div>
          <div class="detail-item" style="grid-column:1/-1"><b>Prestasi</b><span>${esc(ds.prestasi)}</span></div>

          <div class="detail-actions" style="grid-column:1/-1">
            <a class="btn-primary-gradient" href="/dashboard/edit/${esc(ds.id)}">
              <i class="fas fa-pen"></i>&nbsp; Edit
            </a>
          </div>
        </div>
      </div>`;
  }

  // Cek apakah sudah ter-inisialisasi sebelumnya
  const alreadyInit = $.fn.DataTable.isDataTable('#usersTable');

  // Inisialisasi (retrieve:true agar reuse instance lama jika ada)
  const dt = $('#usersTable').DataTable({
    responsive: false,              // pakai child kustom
    retrieve: true,                 // <- kunci anti re-initialize
    lengthChange: false,
    pagingType: 'simple_numbers',
    pageLength: 10,
    dom: "t<'dt-bottom'ip>",        // info & paginate di bawah
    order: [[2, 'asc']],            // sort Nama
    columnDefs: [
      { targets: [0], width: 48 },
      { targets: [8], orderable: false } // kolom Aksi
    ],
    // Hanya buat tombol saat pertama kali init
    buttons: alreadyInit ? [] : [
      { extend: 'excel', text: '<i class="fas fa-file-excel"></i> Export Excel', className: 'dt-btn-green' },
      { extend: 'pdf',   text: '<i class="fas fa-file-pdf"></i> Export PDF',     className: 'dt-btn-green' },
      { extend: 'print', text: '<i class="fas fa-print"></i> Print',             className: 'dt-btn-green' }
    ]
  });

  // Hanya jalankan blok ini sekali (supaya tidak dobel event/toolbar)
  if (!alreadyInit) {
    // Pasang tombol export ke holder
    $('#exportButtons').empty();
    if (dt.buttons && dt.buttons().container) {
      dt.buttons().container().appendTo('#exportButtons');
    }

    // Search khusus kolom Nama (index 2)
    $('#searchNama').off('input.tbl').on('input.tbl', function(){
      dt.column(2).search(this.value).draw();
    });

    // Items per page
    $('#itemsPerPage').off('change.tbl').on('change.tbl', function(){
      dt.page.len(parseInt(this.value, 10)).draw(false);
    });

    // Refresh
    $('#btnRefresh').off('click.tbl').on('click.tbl', function(){
      location.reload();
    });

    // Toggle child row (klik baris selain tombol Aksi)
    $('#usersTable')
      .off('click.tbl', 'tbody td:not(.no-detail)')
      .on('click.tbl', 'tbody td:not(.no-detail)', function (e) {
        if ($(e.target).closest('.btn-action, button, a').length) return;
        const $tr = $(this).closest('tr');
        const row = dt.row($tr);
        const ds  = $tr.get(0).dataset;       // data-* yang kita set di table.ejs
        if (row.child.isShown()) {
          row.child.hide(); $tr.removeClass('shown');
        } else {
          row.child(buildDetail(ds)).show(); $tr.addClass('shown');
        }
      });
  }
})();
</script>
