<!-- Font Awesome Icon -->
<script src="https://kit.fontawesome.com/7cc967098c.js" crossorigin="anonymous"></script>
<!-- Iconify -->
<script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@2.2.1/dist/iconify.min.js"></script>
<!-- jQuery -->
<script src="/adminlte/plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="/adminlte/plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="/adminlte/plugins/chart.js/Chart.min.js"></script>
<!-- Sparkline -->
<script src="/adminlte/plugins/sparklines/sparkline.js"></script>
<!-- JQVMap -->
<script src="/adminlte/plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="/adminlte/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="/adminlte/plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="/adminlte/plugins/moment/moment.min.js"></script>
<script src="/adminlte/plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="/adminlte/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="/adminlte/plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="/adminlte/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="/adminlte/dist/js/adminlte.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/adminlte/dist/js/demo.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="/adminlte/dist/js/pages/dashboard.js"></script>
<!-- bs-custom-file-input -->
<script src="/adminlte/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>

<!-- DataTables & Plugins -->
<script src="/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="/adminlte/plugins/jszip/jszip.min.js"></script>
<script src="/adminlte/plugins/pdfmake/pdfmake.min.js"></script>
<script src="/adminlte/plugins/pdfmake/vfs_fonts.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="/adminlte/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>

<!-- Enhanced DataTable Initialization (NO CSS CONFLICT) -->
<script>
  $(function () {
    // Destroy existing DataTable if exists
    if ($.fn.DataTable.isDataTable('#usersTable')) {
      $('#usersTable').DataTable().destroy();
    }

    // Initialize DataTable with all features
    const table = $('#usersTable').DataTable({
      responsive: false,
      autoWidth: false,
      lengthChange: true,
      searching: true,
      ordering: true,
      info: true,
      paging: true,
      scrollX: true,
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]],
      language: {
        search: "Cari:",
        searchPlaceholder: "Ketik untuk mencari...",
        lengthMenu: "Tampilkan _MENU_ data per halaman",
        info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
        infoEmpty: "Tidak ada data",
        infoFiltered: "(difilter dari _MAX_ total data)",
        zeroRecords: "Tidak ada data yang cocok",
        emptyTable: "Tidak ada data tersedia",
        paginate: {
          first: "Pertama",
          last: "Terakhir",
          next: "Selanjutnya",
          previous: "Sebelumnya"
        }
      },
      dom: '<"datatable-header"<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>>rt<"datatable-footer"<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>>B',
      buttons: [
        {
          extend: 'excel',
          text: '<i class="fas fa-file-excel"></i> Export Excel',
          className: 'btn-export btn-excel',
          title: 'Data Warga HIFI - ' + new Date().toLocaleDateString('id-ID'),
          exportOptions: {
            columns: ':not(.no-export)'
          }
        },
        {
          extend: 'pdf',
          text: '<i class="fas fa-file-pdf"></i> Export PDF',
          className: 'btn-export btn-pdf',
          title: 'Data Warga HIFI',
          orientation: 'landscape',
          pageSize: 'A4',
          exportOptions: {
            columns: ':not(.no-export)'
          }
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print"></i> Print',
          className: 'btn-export btn-print',
          title: 'Data Warga HIFI',
          exportOptions: {
            columns: ':not(.no-export)'
          }
        }
      ],
      initComplete: function() {
        // Custom styling after initialization
        $('.dataTables_wrapper').addClass('glass-card');
        $('.dataTables_filter input').addClass('form-control-glass').attr('placeholder', 'Cari data...');
        $('.dataTables_length select').addClass('form-control-glass');
        
        // Move buttons to header
        $('.dt-buttons').appendTo('.datatable-header .row .col-md-6:first');
        
        console.log('DataTable initialized successfully');
      },
      drawCallback: function() {
        // Add animation to rows on redraw
        $('#usersTable tbody tr').each(function(index) {
          $(this).css({
            'animation': 'fadeInUp 0.3s ease-out',
            'animation-delay': (index * 0.05) + 's'
          });
        });
      }
    });

    // Row click to expand/collapse details
    $('#usersTable tbody').on('click', 'tr', function(e) {
      // Don't expand when clicking action buttons
      if ($(e.target).closest('.btn-action').length > 0) {
        return;
      }

      const row = table.row(this);
      
      if (row.child.isShown()) {
        row.child.hide();
        $(this).removeClass('shown');
      } else {
        // Close other open rows
        table.rows().every(function() {
          if (this.child.isShown()) {
            this.child.hide();
            $(this.node()).removeClass('shown');
          }
        });

        // Open this row
        const data = row.data();
        row.child(formatUserDetails(data)).show();
        $(this).addClass('shown');
      }
    });

    // Format function for row details
    function formatUserDetails(data) {
      const username = data[1].replace(/<[^>]*>/g, '').trim();
      const nama = data[2];
      const npm = data[3];
      const email = data[4];
      const no_hp = data[5];
      const role = data[6].includes('Admin') ? 'Administrator' : 'User';
      const lastUpdate = data[7];
      
      return `
        <div class="detail-card">
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-user-circle"></i> Informasi Personal</h6>
              <p><strong>Username:</strong> ${username}</p>
              <p><strong>Nama Lengkap:</strong> ${nama}</p>
              <p><strong>NPM:</strong> ${npm}</p>
              <p><strong>Role:</strong> ${role}</p>
            </div>
            <div class="col-md-6">
              <h6><i class="fas fa-address-card"></i> Kontak & Informasi</h6>
              <p><strong>Email:</strong> ${email}</p>
              <p><strong>No. HP:</strong> ${no_hp}</p>
              <p><strong>Terakhir Update:</strong> ${lastUpdate}</p>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn-action btn-edit" onclick="editUser('${username}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </div>
      `;
    }
  });

  function editUser(username) {
    $('#usersTable tbody tr').each(function() {
      const rowData = $('#usersTable').DataTable().row(this).data();
      const rowUsername = rowData[1].replace(/<[^>]*>/g, '').trim();
      if (rowUsername === username) {
        const editBtn = $(this).find('.btn-edit')[0];
        if (editBtn) {
          editBtn.click();
        }
        return false;
      }
    });
  }
</script>
</body>
</html>
