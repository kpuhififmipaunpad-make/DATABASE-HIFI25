<script>
/**
 * HIFI Database - Admin Panel Scripts (FIXED & ENHANCED)
 * FULL RESPONSIVE - ALL DEVICES
 * DataTables initialization with custom controls
 */

(function() {
    'use strict';

    // ============================================
    // DATATABLE INITIALIZATION
    // ============================================
    let table;

    function initDataTable() {
        if (!jQuery || !jQuery.fn.DataTable) {
            console.error('❌ jQuery or DataTables not loaded');
            return;
        }

        if (jQuery.fn.DataTable.isDataTable('#usersTable')) {
            console.log('⚠️ DataTable already initialized, destroying...');
            jQuery('#usersTable').DataTable().destroy();
        }

        try {
            table = jQuery('#usersTable').DataTable({
                // Core Settings
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]],
                
                // Responsive
                responsive: true,
                autoWidth: false,
                
                // Language
                language: {
                    search: "Cari:",
                    lengthMenu: "Tampilkan _MENU_ data",
                    info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
                    infoEmpty: "Tidak ada data",
                    infoFiltered: "(difilter dari _MAX_ total data)",
                    paginate: {
                        first: "Pertama",
                        last: "Terakhir",
                        next: "Selanjutnya",
                        previous: "Sebelumnya"
                    },
                    emptyTable: "Tidak ada data tersedia",
                    zeroRecords: "Data tidak ditemukan"
                },
                
                // Column Settings
                columnDefs: [
                    { 
                        targets: 0, 
                        width: '50px',
                        className: 'text-center',
                        orderable: true
                    },
                    { 
                        targets: 1, 
                        width: '200px',
                        orderable: true
                    },
                    { 
                        targets: 2, 
                        width: '120px',
                        className: 'text-center',
                        orderable: true
                    },
                    { 
                        targets: 3, 
                        width: '180px',
                        orderable: true
                    },
                    { 
                        targets: 4, 
                        width: '130px',
                        orderable: false
                    },
                    { 
                        targets: 5, 
                        width: '100px',
                        className: 'text-center',
                        orderable: false
                    },
                    { 
                        targets: 6, 
                        width: '120px',
                        className: 'text-center',
                        orderable: false,
                        searchable: false
                    }
                ],
                
                // Order
                order: [[0, 'asc']],
                
                // DOM Layout (hide default controls, we use custom)
                dom: 'rt',
                
                // Callbacks
                drawCallback: function() {
                    updateTableInfo();
                    updatePagination();
                }
            });

            // Custom Search
            jQuery('#searchNama').on('keyup', function() {
                table.search(this.value).draw();
            });

            // Custom Length Menu
            jQuery('#itemsPerPage').on('change', function() {
                table.page.len(parseInt(this.value)).draw();
            });

            console.log('✅ DataTable initialized successfully');
            
        } catch (error) {
            console.error('❌ DataTable initialization failed:', error);
        }
    }

    // ============================================
    // CUSTOM TABLE INFO
    // ============================================
    function updateTableInfo() {
        if (!table) return;
        
        const info = table.page.info();
        const infoEl = document.getElementById('tableInfo');
        
        if (infoEl) {
            if (info.recordsDisplay === 0) {
                infoEl.innerHTML = 'Tidak ada data yang ditampilkan';
            } else {
                infoEl.innerHTML = `Menampilkan <strong>${info.start + 1}</strong> - <strong>${info.end}</strong> dari <strong>${info.recordsDisplay}</strong> data` +
                    (info.recordsTotal !== info.recordsDisplay ? ` (difilter dari <strong>${info.recordsTotal}</strong> total data)` : '');
            }
        }
    }

    // ============================================
    // CUSTOM PAGINATION
    // ============================================
    function updatePagination() {
        if (!table) return;
        
        const info = table.page.info();
        const paginateEl = document.getElementById('tablePaginate');
        
        if (!paginateEl) return;
        
        if (info.pages <= 1) {
            paginateEl.innerHTML = '';
            return;
        }
        
        let html = '<ul class="pagination" style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin: 0; padding: 0; list-style: none;">';
        
        // Previous Button
        html += `<li class="page-item ${info.page === 0 ? 'disabled' : ''}">
            <a href="#" class="page-link" data-page="prev" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid rgba(30, 58, 138, 0.15); background: rgba(255, 255, 255, 0.9); color: #1F2937; padding: 8px 12px; text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>`;
        
        // Page Numbers
        const currentPage = info.page;
        const totalPages = info.pages;
        let startPage = Math.max(0, currentPage - 2);
        let endPage = Math.min(totalPages - 1, currentPage + 2);
        
        // First page
        if (startPage > 0) {
            html += `<li class="page-item">
                <a href="#" class="page-link" data-page="0" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid rgba(30, 58, 138, 0.15); background: rgba(255, 255, 255, 0.9); color: #1F2937; padding: 8px 12px; text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">1</a>
            </li>`;
            if (startPage > 1) {
                html += `<li class="page-item disabled">
                    <span class="page-link" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; color: #9CA3AF; background: transparent; border: none; padding: 8px 12px;">...</span>
                </li>`;
            }
        }
        
        // Page range
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === currentPage;
            html += `<li class="page-item ${isActive ? 'active' : ''}">
                <a href="#" class="page-link" data-page="${i}" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; ${isActive ? 'background: linear-gradient(135deg, #DC143C 0%, #1E3A8A 100%); color: #fff; border: none; box-shadow: 0 8px 18px rgba(0,0,0,.18);' : 'border: 1px solid rgba(30, 58, 138, 0.15); background: rgba(255, 255, 255, 0.9); color: #1F2937;'} padding: 8px 12px; text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">${i + 1}</a>
            </li>`;
        }
        
        // Last page
        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) {
                html += `<li class="page-item disabled">
                    <span class="page-link" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; color: #9CA3AF; background: transparent; border: none; padding: 8px 12px;">...</span>
                </li>`;
            }
            html += `<li class="page-item">
                <a href="#" class="page-link" data-page="${totalPages - 1}" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid rgba(30, 58, 138, 0.15); background: rgba(255, 255, 255, 0.9); color: #1F2937; padding: 8px 12px; text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">${totalPages}</a>
            </li>`;
        }
        
        // Next Button
        html += `<li class="page-item ${info.page === info.pages - 1 ? 'disabled' : ''}">
            <a href="#" class="page-link" data-page="next" style="min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid rgba(30, 58, 138, 0.15); background: rgba(255, 255, 255, 0.9); color: #1F2937; padding: 8px 12px; text-decoration: none; font-size: 14px; font-weight: 600; transition: all 0.3s ease;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>`;
        
        html += '</ul>';
        paginateEl.innerHTML = html;
        
        // Add event listeners
        paginateEl.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                
                if (this.closest('.page-item').classList.contains('disabled')) return;
                
                if (page === 'prev') {
                    table.page('previous').draw('page');
                } else if (page === 'next') {
                    table.page('next').draw('page');
                } else {
                    table.page(parseInt(page)).draw('page');
                }
            });
            
            // Hover effects
            link.addEventListener('mouseenter', function() {
                if (!this.closest('.page-item').classList.contains('active') && !this.closest('.page-item').classList.contains('disabled')) {
                    this.style.background = 'rgba(30, 58, 138, 0.1)';
                    this.style.color = '#1E3A8A';
                }
            });
            
            link.addEventListener('mouseleave', function() {
                if (!this.closest('.page-item').classList.contains('active')) {
                    this.style.background = 'rgba(255, 255, 255, 0.9)';
                    this.style.color = '#1F2937';
                }
            });
        });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDataTable);
    } else {
        initDataTable();
    }

    // Export to global for debugging
    window.getDataTable = function() {
        return table;
    };
})();
</script>
